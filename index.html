<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>8BPP Palette Creator</title>
    <link rel="stylesheet" href="./css/dos386.css">
</head>

<body onload="setup_palette_grid()">

    <main id="grid-parent-container">
        <navbar>
            <h1>8BPP Palette Creator For Allegro 4.X</h1>
        </navbar>
        <div class="tools-container">
            <button onclick="build_palette_vga(palette)">Create Palette (VGA)</button>
            <button onclick="build_palette_rgb255(palette)">Create Palette (RGB255)</button>
            <button onclick="document.location.reload()">Reset to VGA13h</button>
        </div>
        <div class="export-settings-container">
            <p>Export columns (ie: how many array elements per row)</p>
            <form>
                <select id="export_columns">
                    <option value="1">1 - COLUMN(S)</option>
                    <option value="2">2 - COLUMN(S)</option>
                    <option value="3">3 - COLUMN(S)</option>
                    <!-- looks the nicest in VSCODE 2019 when exported as a header -->
                    <option selected="" value="4">4 - COLUMN(S)</option>
                    <option value="5">5 - COLUMN(S)</option>
                    <option value="6">6 - COLUMN(S)</option>
                    <option value="7">7 - COLUMN(S)</option>
                    <option value="8">8 - COLUMN(S)</option>
                </select>
            </form>
        </div>
    
        <div id="palette_container">
        </div>

        <div id="palette_output_container">
            <pre id="palette_output"></pre>
        </div>
    </main>
    <script>
        //GLOBALS
        //get the div for adding palette selector and palette_output
        let palette_container = document.getElementById("palette_container");
        //get the div for adding palette selector
        let palette_output = document.getElementById("palette_output");
        //grab number of export columns (ie: how many array elements per horizontal row)
        let export_columns = document.getElementById("export_columns");

        let output = "";

        //PALETTE TAKEN FROM ALLEGRO 4.4.2 SOURCE, this is the VGA13h palette *me thinks* (¬_¬ )
        const palette = [
            [0, 0, 0, 0], [0, 0, 42, 0], [0, 42, 0, 0], [0, 42, 42, 0],
            [42, 0, 0, 0], [42, 0, 42, 0], [42, 21, 0, 0], [42, 42, 42, 0],
            [21, 21, 21, 0], [21, 21, 63, 0], [21, 63, 21, 0], [21, 63, 63, 0],
            [63, 21, 21, 0], [63, 21, 63, 0], [63, 63, 21, 0], [63, 63, 63, 0],
            [0, 0, 0, 0], [5, 5, 5, 0], [8, 8, 8, 0], [11, 11, 11, 0],
            [14, 14, 14, 0], [17, 17, 17, 0], [20, 20, 20, 0], [24, 24, 24, 0],
            [28, 28, 28, 0], [32, 32, 32, 0], [36, 36, 36, 0], [40, 40, 40, 0],
            [45, 45, 45, 0], [50, 50, 50, 0], [56, 56, 56, 0], [63, 63, 63, 0],
            [0, 0, 63, 0], [16, 0, 63, 0], [31, 0, 63, 0], [47, 0, 63, 0],
            [63, 0, 63, 0], [63, 0, 47, 0], [63, 0, 31, 0], [63, 0, 16, 0],
            [63, 0, 0, 0], [63, 16, 0, 0], [63, 31, 0, 0], [63, 47, 0, 0],
            [63, 63, 0, 0], [47, 63, 0, 0], [31, 63, 0, 0], [16, 63, 0, 0],
            [0, 63, 0, 0], [0, 63, 16, 0], [0, 63, 31, 0], [0, 63, 47, 0],
            [0, 63, 63, 0], [0, 47, 63, 0], [0, 31, 63, 0], [0, 16, 63, 0],
            [31, 31, 63, 0], [39, 31, 63, 0], [47, 31, 63, 0], [55, 31, 63, 0],
            [63, 31, 63, 0], [63, 31, 55, 0], [63, 31, 47, 0], [63, 31, 39, 0],
            [63, 31, 31, 0], [63, 39, 31, 0], [63, 47, 31, 0], [63, 55, 31, 0],
            [63, 63, 31, 0], [55, 63, 31, 0], [47, 63, 31, 0], [39, 63, 31, 0],
            [31, 63, 31, 0], [31, 63, 39, 0], [31, 63, 47, 0], [31, 63, 55, 0],
            [31, 63, 63, 0], [31, 55, 63, 0], [31, 47, 63, 0], [31, 39, 63, 0],
            [45, 45, 63, 0], [49, 45, 63, 0], [54, 45, 63, 0], [58, 45, 63, 0],
            [63, 45, 63, 0], [63, 45, 58, 0], [63, 45, 54, 0], [63, 45, 49, 0],
            [63, 45, 45, 0], [63, 49, 45, 0], [63, 54, 45, 0], [63, 58, 45, 0],
            [63, 63, 45, 0], [58, 63, 45, 0], [54, 63, 45, 0], [49, 63, 45, 0],
            [45, 63, 45, 0], [45, 63, 49, 0], [45, 63, 54, 0], [45, 63, 58, 0],
            [45, 63, 63, 0], [45, 58, 63, 0], [45, 54, 63, 0], [45, 49, 63, 0],
            [0, 0, 28, 0], [7, 0, 28, 0], [14, 0, 28, 0], [21, 0, 28, 0],
            [28, 0, 28, 0], [28, 0, 21, 0], [28, 0, 14, 0], [28, 0, 7, 0],
            [28, 0, 0, 0], [28, 7, 0, 0], [28, 14, 0, 0], [28, 21, 0, 0],
            [28, 28, 0, 0], [21, 28, 0, 0], [14, 28, 0, 0], [7, 28, 0, 0],
            [0, 28, 0, 0], [0, 28, 7, 0], [0, 28, 14, 0], [0, 28, 21, 0],
            [0, 28, 28, 0], [0, 21, 28, 0], [0, 14, 28, 0], [0, 7, 28, 0],
            [14, 14, 28, 0], [17, 14, 28, 0], [21, 14, 28, 0], [24, 14, 28, 0],
            [28, 14, 28, 0], [28, 14, 24, 0], [28, 14, 21, 0], [28, 14, 17, 0],
            [28, 14, 14, 0], [28, 17, 14, 0], [28, 21, 14, 0], [28, 24, 14, 0],
            [28, 28, 14, 0], [24, 28, 14, 0], [21, 28, 14, 0], [17, 28, 14, 0],
            [14, 28, 14, 0], [14, 28, 17, 0], [14, 28, 21, 0], [14, 28, 24, 0],
            [14, 28, 28, 0], [14, 24, 28, 0], [14, 21, 28, 0], [14, 17, 28, 0],
            [20, 20, 28, 0], [22, 20, 28, 0], [24, 20, 28, 0], [26, 20, 28, 0],
            [28, 20, 28, 0], [28, 20, 26, 0], [28, 20, 24, 0], [28, 20, 22, 0],
            [28, 20, 20, 0], [28, 22, 20, 0], [28, 24, 20, 0], [28, 26, 20, 0],
            [28, 28, 20, 0], [26, 28, 20, 0], [24, 28, 20, 0], [22, 28, 20, 0],
            [20, 28, 20, 0], [20, 28, 22, 0], [20, 28, 24, 0], [20, 28, 26, 0],
            [20, 28, 28, 0], [20, 26, 28, 0], [20, 24, 28, 0], [20, 22, 28, 0],
            [0, 0, 16, 0], [4, 0, 16, 0], [8, 0, 16, 0], [12, 0, 16, 0],
            [16, 0, 16, 0], [16, 0, 12, 0], [16, 0, 8, 0], [16, 0, 4, 0],
            [16, 0, 0, 0], [16, 4, 0, 0], [16, 8, 0, 0], [16, 12, 0, 0],
            [16, 16, 0, 0], [12, 16, 0, 0], [8, 16, 0, 0], [4, 16, 0, 0],
            [0, 16, 0, 0], [0, 16, 4, 0], [0, 16, 8, 0], [0, 16, 12, 0],
            [0, 16, 16, 0], [0, 12, 16, 0], [0, 8, 16, 0], [0, 4, 16, 0],
            [8, 8, 16, 0], [10, 8, 16, 0], [12, 8, 16, 0], [14, 8, 16, 0],
            [16, 8, 16, 0], [16, 8, 14, 0], [16, 8, 12, 0], [16, 8, 10, 0],
            [16, 8, 8, 0], [16, 10, 8, 0], [16, 12, 8, 0], [16, 14, 8, 0],
            [16, 16, 8, 0], [14, 16, 8, 0], [12, 16, 8, 0], [10, 16, 8, 0],
            [8, 16, 8, 0], [8, 16, 10, 0], [8, 16, 12, 0], [8, 16, 14, 0],
            [8, 16, 16, 0], [8, 14, 16, 0], [8, 12, 16, 0], [8, 10, 16, 0],
            [11, 11, 16, 0], [12, 11, 16, 0], [13, 11, 16, 0], [15, 11, 16, 0],
            [16, 11, 16, 0], [16, 11, 15, 0], [16, 11, 13, 0], [16, 11, 12, 0],
            [16, 11, 11, 0], [16, 12, 11, 0], [16, 13, 11, 0], [16, 15, 11, 0],
            [16, 16, 11, 0], [15, 16, 11, 0], [13, 16, 11, 0], [12, 16, 11, 0],
            [11, 16, 11, 0], [11, 16, 12, 0], [11, 16, 13, 0], [11, 16, 15, 0],
            [11, 16, 16, 0], [11, 15, 16, 0], [11, 13, 16, 0], [11, 12, 16, 0],
            [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0],
            [0, 0, 0, 0], [0, 0, 0, 0], [0, 0, 0, 0], [63, 63, 63, 0]
        ];

        function setup_palette_grid() {
            let palette_index = 0;
            palette.forEach(color => {
                //for some reason rgb(255,...,...) doesn't work here with input color so just wrote 
                //methods to provide hex
                palette_container.innerHTML
                    += "<input id='color" + palette_index + "'' onchange=\"change_palette_index(" + palette_index + ")\" type='color' value='" + rge_vga_to_hex(color[0], color[1], color[2]) + "'/>";
                palette_index++;
            });
        }

        function change_palette_index(palette_index) {
            //grab the color wheel by id
            let color_wheel_element = document.getElementById("color" + palette_index);

            console.log(palette[palette_index]);

            //update palette array
            let rgb255 = hex_to_int(color_wheel_element.value);
            palette[palette_index][0] = Math.floor((rgb255.r / 255) * 63);
            palette[palette_index][1] = Math.floor((rgb255.g / 255) * 63);
            palette[palette_index][2] = Math.floor((rgb255.b / 255) * 63);

            console.log(palette[palette_index]);
        }

        //assumes colors are always of the format #ffffff, or 6 bytes (ff=2bytes * 3 blocks)
        function hex_to_int(val) {
            let r = parseInt(val.substring(1, 3), 16);  //convert string that is in base 16 hex tp base 10
            let g = parseInt(val.substring(3, 5), 16);
            let b = parseInt(val.substring(5, 7), 16);
            return { "r": r.toString(10), "g": g.toString(10), "b": b.toString(10) };
        }

        function int_to_hex(val) {
            //will return single hex component so we need to double up with zero if its below 
            //F (so we don't get F, when we expect 0F)
            let hex = val.toString(16);
            return hex.length == 1 ? "0" + hex : hex;
        }

        function rge_vga_to_hex(r, g, b) {
            return "#" + int_to_hex(Math.floor((r / 63 * 255)))
                + int_to_hex(Math.floor((g / 63 * 255)))
                + int_to_hex(Math.floor((b / 63 * 255)));
        }

        function rge_rgb255_to_hex(r, g, b) {
            return "#" + int_to_hex(r) + int_to_hex(g) + int_to_hex(b);
        }


        //assumes color data is VGA 0-63
        //we store the array in VGA so unless were modifying something else
        //array is already in vga
        function rge_rgb255_to_vga(r, g, b, skip_conversion) {
            if (skip_conversion) {
                return "{"
                    + Math.floor((r / 255) * 63) + ","
                    + Math.floor((g / 255) * 63) + ","
                    + Math.floor((b / 255) * 63) + "}";
            } else {
                return "{"
                    + Math.floor(r) + ","
                    + Math.floor(g) + ","
                    + Math.floor(b) + "}";
            }
        }

        function rge_vga_to_rgb255(r, g, b) {
            return "{"
                + Math.floor((r / 63) * 255) + ","
                + Math.floor((g / 63) * 255) + ","
                + Math.floor((b / 63) * 255) + "}";
        }

        function start_palette(palette_type) {
            //reset output
            output = "";

            output += "//>>START OF PALETTE<<\n";
            output += "//------------------------\n\n";
            output += "//THIS PALETTE IS A " + palette_type + " \n";

            //start c array
            output += "PALETTE RGE_PALETTES = {\n";
        }

        function print_palette(conversion_func_callback) {

            //check callback is vga or 255 callback and set tab
            //note: depending on font loaded
            //we may need to adjust tabs below (we assume monospace)
            //which doesn't but if we load something other then monospace
            //<pre> output will look bad
            let tabs = (conversion_func_callback.name.includes("255")) ? "\t" : "\t";

            //get number of columns to generate
            //index 0=1 columns
            //index 1=2 columns
            //...
            let num_columns = (export_columns.selectedIndex);
            let column = 0;

            for (let i = 0; i < palette.length; i++) {
                if (i != palette.length - 1) {
                    output += tabs + conversion_func_callback(palette[i][0], palette[i][1], palette[i][2]) + ",";
                    column++;
                    //we could just use % here and save some space but meh ¯\_(ツ)_/¯
                    switch (num_columns) {
                        //1 column(s)
                        case 0:
                            if (column === 1) { output += "\n"; column = 0; }
                        //2 column(s)
                        case 1:
                            if (column === 2) { output += "\n"; column = 0; }
                        //3 column(s)
                        case 2:
                            if (column === 3) { output += "\n"; column = 0; }
                        //4 column(s)
                        case 3:
                            if (column === 4) { output += "\n"; column = 0; }
                            break;
                        //5 column(s)
                        case 4:
                            if (column === 5) { output += "\n"; column = 0; }
                            break;
                        //6 column(s)
                        case 5:
                            if (column === 6) { output += "\n"; column = 0; }
                            break;
                        //7 column(s)
                        case 6:
                            if (column === 7) { output += "\n"; column = 0; }
                            break;
                        //8 column(s)
                        case 7:
                            if (column === 8) { output += "\n"; column = 0; }
                            break;
                    }
                } else {
                    //last line, don't add ","
                    output += tabs + conversion_func_callback(palette[i][0], palette[i][1], palette[i][2]) + "\n";
                }
            }
        }

        function end_palette() {
            output += "};\n\n";
            output += "//>>END OF PALETTE<<\n";
            output += "//------------------------\n";
            palette_output.innerText = output;
        }

        function build_palette_vga(palette) {
            start_palette("VGA Palette (r,g,b ranges from 0-63)...");
            print_palette(rge_rgb255_to_vga);
            end_palette();
        }

        function build_palette_rgb255(palette) {
            start_palette("RGB255 Palette (r,g,b ranges from 0-255)...");
            print_palette(rge_vga_to_rgb255);
            end_palette();

        }
    </script>

</body>

</html>